<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tech.whale.admin.dao.AdminReportIDao">

	<sql id="includeReportCnt">
	    <choose>
	        <when test="param2 == 1">
	            WHERE (USER_ID LIKE '%' || #{sk} || '%')
	        </when>
	        <otherwise>
	        </otherwise>
	    </choose>
	</sql>
	
	<sql id="includeReportList">
	    <choose>
	        <when test="param4 == 1">
	            AND (USER_ID LIKE '%' || #{sk} || '%')
	        </when>
	        <otherwise>
	        </otherwise>
	    </choose>
	</sql>
	
	
	<select id="selectReportCnt" parameterType="map" resultType="int">
        SELECT COUNT(*) FROM REPORT
        <include refid="includeReportCnt" />
    </select>
    
    <select id="adminReportList" resultType="com.tech.whale.admin.dto.AdminReportListDto">
	    SELECT *
	    FROM (
	        SELECT
	            REPORT_ID,
	            USER_ID,
	            FEED_ID,
	            FEED_COMMENT_ID,
	            POST_ID,
	            POST_COMMENT_ID,
	            MESSAGE_ID,
	            REPORT_WHY,
	            REPORT_DATE,
	            REPORT_TAG,
	            REPORT_TEXT,
	            REPORT_IMG_URL,
	            REPORT_ADMIN_CHECK,
	            COUNT(*) OVER (
	                PARTITION BY COALESCE(FEED_ID, FEED_COMMENT_ID, POST_ID, POST_COMMENT_ID, MESSAGE_ID)
	            ) AS SAME_CONTENT_COUNT,
	            ROW_NUMBER() OVER (ORDER BY REPORT_ID DESC) AS RNUM
	        FROM REPORT
	    ) 
	    WHERE RNUM BETWEEN #{start} AND #{end}
		<include refid="includeReportList" />
	    
	</select>
    <select id="reportContent" resultType="com.tech.whale.admin.dto.AdminReportResultDto">
	    SELECT 
	    R.REPORT_ID,
	    R.USER_ID,
	    R.FEED_ID,
	    R.FEED_COMMENT_ID,
	    R.POST_ID,
	    R.POST_COMMENT_ID,
	    R.MESSAGE_ID,
	    R.REPORT_WHY,
	    R.REPORT_DATE,
	    R.REPORT_TAG,
	    R.REPORT_TEXT,
	    R.REPORT_IMG_URL,
	    R.REPORT_ADMIN_CHECK,
	    RR.REPORT_LOG_ID,
	    RR.TARGET_TYPE,
	    RR.TARGET_ID,
	    RR.ADMIN_ID,
	    RR.REPORT_RESULT_DATE,
	    RR.REPORT_RESULT_ACTION,
	    RR.REPORT_RESULT_REASON
	FROM 
	    REPORT R
	LEFT JOIN 
	    REPORT_RESULT RR
	ON 
	    R.REPORT_ID = RR.REPORT_ID
	WHERE
		R.REPORT_ID = #{report_id}
	ORDER BY 
	    R.REPORT_ID, RR.REPORT_RESULT_DATE

	    
	</select>
    
    
	
   
	
	
	
</mapper>