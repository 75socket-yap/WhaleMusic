<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.tech.whale.admin.dao.AdminStatisticIDao">
	
	<select id="reportStatistic1" resultType="com.tech.whale.admin.dto.AdminLVDataDto">
		WITH LABEL AS (
		    SELECT 'FEED' AS LABEL FROM DUAL UNION ALL
		    SELECT 'FEED_COMMENT' FROM DUAL UNION ALL
		    SELECT 'POST' FROM DUAL UNION ALL
		    SELECT 'POST_COMMENT' FROM DUAL UNION ALL
		    SELECT 'MESSAGE' FROM DUAL
		)
		SELECT 
		    RT.LABEL,
		    COUNT(CASE 
		        WHEN RT.LABEL = 'FEED' AND R.FEED_ID IS NOT NULL THEN 1
		        WHEN RT.LABEL = 'FEED_COMMENT' AND R.FEED_COMMENT_ID IS NOT NULL THEN 1
		        WHEN RT.LABEL = 'POST' AND R.POST_ID IS NOT NULL THEN 1
		        WHEN RT.LABEL = 'POST_COMMENT' AND R.POST_COMMENT_ID IS NOT NULL THEN 1
		        WHEN RT.LABEL = 'MESSAGE' AND R.MESSAGE_ID IS NOT NULL THEN 1
		        ELSE NULL
		    END) AS VALUE
		FROM LABEL RT
		LEFT JOIN REPORT R ON 1=1
		GROUP BY RT.LABEL
		ORDER BY RT.LABEL
	</select>
	<select id="reportStatistic2" resultType="com.tech.whale.admin.dto.AdminLVDataDto">
		WITH DATE_RANGE AS (
		    SELECT TRUNC(SYSDATE) - LEVEL + 1 AS TARGET_DATE
		    FROM DUAL
		    CONNECT BY LEVEL &lt;= 14
		)
		SELECT 
		    TO_CHAR(DR.TARGET_DATE, 'MM.DD') AS LABEL,
		    (
		        NVL((SELECT COUNT(*) FROM POST WHERE TRUNC(POST_DATE) = DR.TARGET_DATE), 0) +
		        NVL((SELECT COUNT(*) FROM FEED WHERE TRUNC(FEED_DATE) = DR.TARGET_DATE), 0) +
		        NVL((SELECT COUNT(*) FROM POST_COMMENTS WHERE TRUNC(POST_COMMENTS_DATE) = DR.TARGET_DATE), 0) +
		        NVL((SELECT COUNT(*) FROM FEED_COMMENTS WHERE TRUNC(FEED_COMMENTS_DATE) = DR.TARGET_DATE), 0)
		    ) AS VALUE
		FROM DATE_RANGE DR
		ORDER BY DR.TARGET_DATE DESC
	</select>
	<select id="reportStatistic3" resultType="com.tech.whale.admin.dto.AdminLVDataDto">
		SELECT RANGES.LABEL, NVL(COUNTS.VALUE, 0) AS VALUE
		FROM (
		    SELECT '1일이내' AS LABEL FROM DUAL
		    UNION ALL
		    SELECT '2-3일' FROM DUAL
		    UNION ALL
		    SELECT '3일초과' FROM DUAL
		) RANGES
		LEFT JOIN (
		    SELECT 
		        CASE 
		            WHEN (REPORT_RESULT.REPORT_RESULT_DATE - REPORT.REPORT_DATE) * 24 &lt;= 24 THEN '1일이내'
		            WHEN (REPORT_RESULT.REPORT_RESULT_DATE - REPORT.REPORT_DATE) * 24 &gt; 24 
		                 AND (REPORT_RESULT.REPORT_RESULT_DATE - REPORT.REPORT_DATE) * 24 &lt;= 72 THEN '2-3일'
		            ELSE '3일초과'
		        END AS LABEL,
		        COUNT(*) AS VALUE
		    FROM 
		        REPORT_RESULT
		    JOIN 
		        REPORT ON REPORT_RESULT.REPORT_ID = REPORT.REPORT_ID
		    WHERE 
		        REPORT_RESULT.REPORT_RESULT_DATE IS NOT NULL 
		        AND REPORT.REPORT_DATE IS NOT NULL
		    GROUP BY 
		        CASE 
		            WHEN (REPORT_RESULT.REPORT_RESULT_DATE - REPORT.REPORT_DATE) * 24 &lt;= 24 THEN '1일이내'
		            WHEN (REPORT_RESULT.REPORT_RESULT_DATE - REPORT.REPORT_DATE) * 24 &gt; 24 
		                 AND (REPORT_RESULT.REPORT_RESULT_DATE - REPORT.REPORT_DATE) * 24 &lt;= 72 THEN '2-3일'
		            ELSE '3일초과'
		        END
		) COUNTS ON RANGES.LABEL = COUNTS.LABEL
		ORDER BY RANGES.LABEL
	</select>
	<select id="userStatistic1" resultType="com.tech.whale.admin.dto.AdminLVDataDto">
		WITH DATE_RANGE AS (
		    SELECT TO_CHAR(SYSDATE - LEVEL + 1, 'YYYY-MM-DD') AS LABEL
		    FROM DUAL
		    CONNECT BY LEVEL &lt;= 14
		),
		DAILY_USER_COUNT AS (
		    SELECT 
		        TO_CHAR(USER_DATE, 'YYYY-MM-DD') AS LABEL,
		        COUNT(*) AS DAILY_COUNT
		    FROM USER_INFO
		    WHERE USER_DATE &gt;= TRUNC(SYSDATE) - 13
		    GROUP BY TO_CHAR(USER_DATE, 'YYYY-MM-DD')
		),
		TOTAL_USER_COUNT AS (
		    SELECT COUNT(*) AS TOTAL_COUNT
		    FROM USER_INFO
		)
		SELECT 
		    DR.LABEL,
		    (SELECT TOTAL_COUNT FROM TOTAL_USER_COUNT) - 
		    NVL(SUM(DUC.DAILY_COUNT) OVER (ORDER BY DR.LABEL DESC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW), 0) AS VALUE
		FROM 
		    DATE_RANGE DR
		LEFT JOIN 
		    DAILY_USER_COUNT DUC ON DR.LABEL = DUC.LABEL
		ORDER BY 
		    DR.LABEL
	</select>
	
</mapper>